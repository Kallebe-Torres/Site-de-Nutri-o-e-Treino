<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Recuperar Senha - Multi-Etapas</title>

    <style>
        /* Importação da Fonte e Cores */
        @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap");

        :root {
            --color1: #00ccbe; /* Cor Teal Principal */
            --color2: #09a6a3; /* Cor Teal Escura (Botões, Ícones) */
            --color-text: #333333;
            --color-light-text: #555555;
            --color-bg: #f4f7f9;
            --color-card: #ffffff;
            --color-shadow: rgba(0, 0, 0, 0.12);
            --color-border: #e0e0e0;
        }

        * {
            padding: 0;
            margin: 0;
            box-sizing: border-box;
            font-family: "Inter", sans-serif;
        }

        body {
            width: 100%;
            height: 100vh;
            display: flex;
            background-color: var(--color-bg);
            justify-content: center;
            align-items: center;
        }

        /* CONTAINER PRINCIPAL */
        .container {
            width: 100%;
            max-width: 500px;
            display: flex;
            background-color: var(--color-card);
            box-shadow: 0 12px 35px var(--color-shadow);
            border-radius: 16px;
            overflow: hidden;
            padding: 50px 40px;
            border: 1px solid var(--color-border);
            position: relative;
        }

        .form {
            width: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        /* CABEÇALHO E TÍTULO */
        .form-header {
            width: 100%;
            margin-bottom: 25px;
            text-align: center;
        }

        .title h1 {
            font-size: 32px;
            color: var(--color-text);
            margin-bottom: 8px;
        }

        .title h1::after {
            content: "";
            display: block;
            width: 60px;
            height: 3px;
            background-color: var(--color1);
            margin: 8px auto 0;
            border-radius: 10px;
        }

        /* Botão/Link "Voltar ao Login" */
        .back-to-login {
            text-align: center;
            margin-top: 25px;
        }
        .back-to-login a {
            text-decoration: none;
            font-weight: 600;
            color: var(--color-light-text);
            transition: color 0.3s;
            font-size: 15px;
        }
        .back-to-login a:hover {
            color: var(--color2);
            text-decoration: underline;
        }

        /* Mensagem Informativa */
        .form > p {
            font-size: 16px;
            line-height: 1.6;
            color: var(--color-light-text);
            margin-bottom: 35px !important;
            text-align: center;
        }

        /* INPUTS */
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 100%;
            margin-bottom: 30px;
        }

        .input-box {
            display: flex;
            flex-direction: column;
        }

        .input-box label {
            font-size: 15px;
            font-weight: 600;
            color: var(--color-text);
            margin-bottom: 8px;
        }

        .input-box input {
            padding: 14px 18px;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.04);
            font-size: 17px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .input-box input:focus {
            border-color: var(--color1);
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 204, 190, 0.25);
        }
        
        /* Ajuste Específico para o Código de Acesso */
        #code {
            text-align: center;
            letter-spacing: 5px; 
        }

        /* BOTÃO PRINCIPAL */
        .main-button {
            width: 100%;
            border: none;
            background-color: var(--color2);
            padding: 16px;
            border-radius: 8px;
            cursor: pointer;
            color: #fff;
            font-size: 19px;
            font-weight: 700;
            transition: background-color 0.3s, transform 0.1s;
        }

        .main-button:hover:not(:disabled) {
            background-color: var(--color1);
        }

        .main-button:active:not(:disabled) {
            transform: scale(0.99);
        }

        .main-button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        
        /* ESTRUTURA MULTI-ETAPAS */
        .step-content {
            display: none;
            width: 100%;
            flex-direction: column;
            align-items: center;
        }

        .step-content.active {
            display: flex;
        }

        /* BARRA DE PROGRESSO (Opcional, mas profissional) */
        .progress-bar-container {
            width: 100%;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }
        .progress-bar-container::before {
            content: '';
            position: absolute;
            height: 4px;
            width: 100%;
            background-color: var(--color-border);
            z-index: 1;
        }
        .step-point {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: var(--color-border);
            color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: 700;
            font-size: 14px;
            transition: background-color 0.4s;
            z-index: 2;
        }
        .step-point.completed {
            background-color: var(--color1);
        }


        /* AJUSTES DE RESPONSIVIDADE */
        @media screen and (max-width: 550px) {
            .container {
                width: 90%;
                padding: 40px 25px;
            }
            .title h1 {
                font-size: 28px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="form">
            
            <div class="progress-bar-container">
                <div id="step-1-point" class="step-point completed">1</div>
                <div id="step-2-point" class="step-point">2</div>
                <div id="step-3-point" class="step-point">3</div>
            </div>

            <form id="forgot-form-step1" class="step-content active">
                <div class="form-header">
                    <div class="title">
                        <h1 id="step-title">Recuperar Senha</h1>
                    </div>
                </div>

                <p id="step-message">
                    Digite seu e-mail para enviarmos o código de acesso.
                </p>

                <div class="input-group">
                    <div class="input-box">
                        <label for="email">E-mail</label>
                        <input id="email" type="email" name="email" placeholder="Digite seu e-mail" required />
                    </div>
                </div>

                <button type="submit" class="main-button" id="btn-step1">Enviar Código</button>
            </form>

            <form id="forgot-form-step2" class="step-content">
                <div class="form-header">
                    <div class="title">
                        <h1>Verificar Código</h1>
                    </div>
                </div>

                <p id="email-display">
                    Enviamos um código para seu e-mail.
                </p>

                <div class="input-group">
                    <div class="input-box">
                        <label for="code">Código de Acesso</label>
                        <input 
                            id="code" 
                            type="text" 
                            name="code" 
                            placeholder="Digite o código de 6 dígitos" 
                            required 
                            inputmode="numeric"
                            pattern="[0-9]{6}"
                            maxlength="6"
                        />
                    </div>
                </div>

                <button type="submit" class="main-button" id="btn-step2">Verificar</button>
                
                <div class="back-to-login" style="margin-top: 15px;">
                    <a href="#" id="change-email-link">Mudar E-mail / Reenviar Código</a>
                </div>
            </form>

            <form id="forgot-form-step3" class="step-content">
                <div class="form-header">
                    <div class="title">
                        <h1>Nova Senha</h1>
                    </div>
                </div>

                <p>
                    Digite e confirme sua nova senha.
                </p>

                <div class="input-group">
                    <div class="input-box">
                        <label for="new-password">Nova Senha</label>
                        <input id="new-password" type="password" name="new-password" placeholder="Mínimo 6 caracteres" minlength="6" required />
                    </div>
                    <div class="input-box">
                        <label for="confirm-password">Confirmar Senha</label>
                        <input id="confirm-password" type="password" name="confirm-password" placeholder="Repita a nova senha" minlength="6" required />
                    </div>
                </div>

                <button type="submit" class="main-button" id="btn-step3">Redefinir Senha</button>
            </form>
            
            <div class="back-to-login">
                <a href="login.html">Voltar para o Login</a>
            </div>
            
        </div>
    </div>
    
    <script>
        const API_BASE_URL = "http://localhost:3001";
        
        // Elementos DOM
        const forms = {
            1: document.getElementById('forgot-form-step1'),
            2: document.getElementById('forgot-form-step2'),
            3: document.getElementById('forgot-form-step3'),
        };
        const buttons = {
            1: document.getElementById('btn-step1'),
            2: document.getElementById('btn-step2'),
            3: document.getElementById('btn-step3'),
        };
        const inputs = {
            email: document.getElementById('email'),
            code: document.getElementById('code'),
            newPassword: document.getElementById('new-password'),
            confirmPassword: document.getElementById('confirm-password'),
            emailDisplay: document.getElementById('email-display'),
            changeEmailLink: document.getElementById('change-email-link')
        };
        const stepPoints = {
            1: document.getElementById('step-1-point'),
            2: document.getElementById('step-2-point'),
            3: document.getElementById('step-3-point'),
        };

        // Estado Global
        let currentStep = 1;
        let userEmail = '';
        let resetToken = ''; // Recebido após a verificação do código

        // Função para Navegar entre Etapas
        function navigateToStep(step) {
            if (step < 1 || step > 3) return;

            // Esconde todas as etapas
            Object.values(forms).forEach(form => form.classList.remove('active'));
            // Remove o status 'completed' de todas as etapas à frente
            for (let i = step; i <= 3; i++) {
                stepPoints[i].classList.remove('completed');
            }
            
            // Exibe a etapa atual e atualiza o estado
            forms[step].classList.add('active');
            stepPoints[step].classList.add('completed');
            currentStep = step;
            
            // Limpa o token e o código se voltar ao início
            if (step === 1) {
                resetToken = '';
                inputs.code.value = '';
                inputs.newPassword.value = '';
                inputs.confirmPassword.value = '';
            }
        }
        
        // Função para Habilitar/Desabilitar Botão
        function toggleButtonLoading(btn, isLoading, defaultText) {
            btn.textContent = isLoading ? 'Aguarde...' : defaultText;
            btn.disabled = isLoading;
        }

        // --- Evento de Envio da Etapa 1: Enviar E-mail ---
        forms[1].addEventListener('submit', async (e) => {
            e.preventDefault();
            userEmail = inputs.email.value;
            toggleButtonLoading(buttons[1], true, 'Enviar Código');

            // Simulação de chamada de API (Substitua pelo seu código real)
            try {
                const response = await fetch(`${API_BASE_URL}/api/auth/forgot-password/request`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: userEmail })
                });

                const data = await response.json();

                if (response.ok) {
                    alert('Código enviado com sucesso para: ' + userEmail);
                    inputs.emailDisplay.textContent = `Enviamos um código para: ${userEmail}`;
                    navigateToStep(2);
                } else {
                    alert(data.message || 'Falha ao enviar o código. Verifique o e-mail.');
                }
            } catch (error) {
                alert('Erro de conexão com o servidor. Verifique o console.');
                console.error('Fetch Error:', error);
            } finally {
                toggleButtonLoading(buttons[1], false, 'Enviar Código');
            }
        });

        // --- Evento de Envio da Etapa 2: Verificar Código ---
        forms[2].addEventListener('submit', async (e) => {
            e.preventDefault();
            const code = inputs.code.value;
            
            if (!userEmail) { alert("E-mail não definido. Volte à Etapa 1."); return; }
            if (code.length !== 6 || isNaN(code)) { alert("O código deve ter 6 dígitos numéricos."); return; }

            toggleButtonLoading(buttons[2], true, 'Verificar');
            
            // Simulação de chamada de API (Substitua pelo seu código real)
            try {
                const response = await fetch(`${API_BASE_URL}/api/auth/forgot-password/verify-code`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: userEmail, code: code })
                });

                const data = await response.json();

                if (response.ok) {
                    alert('Código verificado com sucesso! Crie sua nova senha.');
                    resetToken = data.resetToken; // Armazena o token para a próxima etapa
                    navigateToStep(3);
                } else {
                    alert(data.message || 'Código inválido ou expirado.');
                }
            } catch (error) {
                alert('Erro de conexão com o servidor.');
            } finally {
                toggleButtonLoading(buttons[2], false, 'Verificar');
            }
        });
        
        // Ação do link "Mudar E-mail / Reenviar Código"
        inputs.changeEmailLink.addEventListener('click', (e) => {
            e.preventDefault();
            navigateToStep(1);
        });

        // --- Evento de Envio da Etapa 3: Redefinir Senha ---
        forms[3].addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const newPassword = inputs.newPassword.value;
            const confirmPassword = inputs.confirmPassword.value;

            // Validações de frontend
            if (newPassword !== confirmPassword) {
                alert("As senhas não conferem!");
                return;
            }
            if (newPassword.length < 6) {
                alert("A nova senha deve ter no mínimo 6 caracteres.");
                return;
            }
            if (!userEmail || !resetToken) {
                alert("Erro de segurança: Token ou e-mail faltando. Reinicie o processo.");
                navigateToStep(1);
                return;
            }

            toggleButtonLoading(buttons[3], true, 'Redefinir Senha');

            // Simulação de chamada de API (Substitua pelo seu código real)
            try {
                const response = await fetch(`${API_BASE_URL}/api/auth/forgot-password/reset`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        email: userEmail, 
                        token: resetToken, 
                        newPassword: newPassword 
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    alert('✅ Senha redefinida com sucesso! Você será redirecionado para o login.');
                    // ✅ Redireciona para o login (ou onde o login.html estiver)
                    window.location.href = 'login.html'; 
                } else {
                    alert(data.message || 'Falha ao redefinir a senha. Tente novamente.');
                }
            } catch (error) {
                alert('Erro de conexão com o servidor.');
            } finally {
                toggleButtonLoading(buttons[3], false, 'Redefinir Senha');
            }
        });
    </script>
</body>
</html>